<Window x:Class="Bai2.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Bai2"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800"
        Loaded="Window_Loaded"
        >
        
    <Window.Resources>
        <Style TargetType="Button">
            <Setter Property="Background" Value="SkyBlue" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border CornerRadius="40"
                                    Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="White"/>
            <Style.Triggers>
                <Trigger Property="IsFocused" Value="True">
                    <Setter Property="Background" Value="SkyBlue" />
                </Trigger>
            </Style.Triggers>    
        </Style>
    </Window.Resources>
    
    <Grid>
        <Label Content="Mã sách" HorizontalAlignment="Left" Margin="63,17,0,0" VerticalAlignment="Top" Width="100" Height="35"/>
        <Label Content="Tên sách" HorizontalAlignment="Left" Margin="63,57,0,0" VerticalAlignment="Top" Width="100" Height="35"/>
        <Label Content="Năm xuất bản" HorizontalAlignment="Left" Margin="63,97,0,0" VerticalAlignment="Top" Width="100" Height="35"/>
        <Label Content="Số trang" HorizontalAlignment="Left" Margin="63,137,0,0" VerticalAlignment="Top" Width="100" Height="35"/>
        <Label Content="Tác giả" HorizontalAlignment="Left" Margin="63,177,0,0" VerticalAlignment="Top" Width="100" Height="35"/>
        <TextBox x:Name="txtMa" HorizontalAlignment="Left" Margin="168,22,0,0" TextWrapping="Wrap" VerticalAlignment="Top" Width="180" Height="25" FontFamily="Times New Roman"/>
        <TextBox x:Name="txtName" HorizontalAlignment="Left" Margin="168,62,0,0" TextWrapping="Wrap" VerticalAlignment="Top" Width="180" Height="25"/>
        <TextBox x:Name="txtNamXB" HorizontalAlignment="Left" Margin="168,102,0,0" TextWrapping="Wrap" VerticalAlignment="Top" Width="180" Height="25"/>
        <TextBox x:Name="txtTrang" HorizontalAlignment="Left" Margin="168,142,0,0" TextWrapping="Wrap" VerticalAlignment="Top" Width="180" Height="25" FontFamily="Times New Roman"/>
        <ComboBox x:Name="cbTG" HorizontalAlignment="Left" Margin="168,179,0,0" VerticalAlignment="Top" Width="180"/>
        <DataGrid x:Name="dgSach" AutoGenerateColumns="False" SelectedCellsChanged="dgSach_SelectedCellsChanged" Margin="60,233,60,69" FontSize="14">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Mã sách" Binding="{Binding MaSach, Mode=OneWay}"></DataGridTextColumn>
                <DataGridTextColumn Header="Tên sách" Binding="{Binding TenSach, Mode=OneWay}" Width="150"></DataGridTextColumn>
                <DataGridTextColumn Header="Mã tác giả" Binding="{Binding MaTG, Mode=OneWay}"></DataGridTextColumn>
                <DataGridTextColumn Header="Năm xuất bản" Binding="{Binding NamXB, Mode=OneWay}"></DataGridTextColumn>
                <DataGridTextColumn Header="Số trang" Binding="{Binding SoTrang, Mode=OneWay}"></DataGridTextColumn>
                <DataGridTextColumn Header="Thành tiền" Binding="{Binding TongTien, Mode=OneWay}" Foreground="Red" FontStyle="Italic" Width="*"></DataGridTextColumn>
            </DataGrid.Columns>
            <DataGrid.Resources>
                <Style TargetType="DataGridColumnHeader">
                    <Setter Property="FontWeight" Value="Bold"></Setter>
                </Style>
            </DataGrid.Resources>
        </DataGrid>
        <Button Content="Thêm" x:Name="btnThem" HorizontalAlignment="Left" Margin="153,388,0,0" VerticalAlignment="Top" Height="25" Width="80" Background="YellowGreen" Click="btnThem_Click"/>
        <Button Content="Sửa" x:Name="btnSua" HorizontalAlignment="Left" Margin="293,388,0,0" VerticalAlignment="Top" Height="25" Width="80" Background="YellowGreen" Click="btnSua_Click"/>
        <Button Content="Xóa" x:Name="btnXoa" HorizontalAlignment="Left" Margin="435,388,0,0" VerticalAlignment="Top" Height="25" Width="80" Background="YellowGreen" Click="btnXoa_Click"/>
        <Button Content="Thống kê" x:Name="btnTK" HorizontalAlignment="Left" Margin="575,388,0,0" VerticalAlignment="Top" Height="25" Width="80" Background="YellowGreen" Click="btnTK_Click"/>

    </Grid>
</Window>

using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using Bai2.Models;

namespace Bai2
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        QLSachContext db = new QLSachContext();

        private List<TT> LayDL()
        {
            var query = from t in db.Saches
                        where t.SoTrang >= 120
                        orderby t.SoTrang ascending
                        select new TT
                        {
                            MaSach = t.MaSach,
                            TenSach = t.TenSach,
                            MaTG = t.MaTg,
                            NamXB = t.NamXuatBan,
                            SoTrang = t.SoTrang,
                            TongTien = t.SoTrang * 80000
                        };
            return query.ToList<TT>();
        }

        private void HienThiDL()
        {
            dgSach.ItemsSource = LayDL();
        }

        private void HienThiCB()
        {
            var query = from t in db.TacGia
                        select t;
            cbTG.ItemsSource = query.ToList();
            cbTG.DisplayMemberPath = "TenTacGia";
            cbTG.SelectedValuePath = "MaTG";
            cbTG.SelectedIndex = 0;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            HienThiDL();
            HienThiCB();
        }

        public MainWindow()
        {
            InitializeComponent();
        }

        private void dgSach_SelectedCellsChanged(object sender, SelectedCellsChangedEventArgs e)
        {
            if(dgSach.SelectedItem != null)
            {
                try
                {
                    Type t = dgSach.SelectedItem.GetType();
                    PropertyInfo[] p = t.GetProperties();
                    txtMa.Text = p[0].GetValue(dgSach.SelectedValue).ToString();
                    txtName.Text = p[1].GetValue(dgSach.SelectedValue).ToString();
                    txtNamXB.Text = p[3].GetValue(dgSach.SelectedValue).ToString();
                    txtTrang.Text = p[4].GetValue(dgSach.SelectedValue).ToString();
                    cbTG.SelectedValue = p[2].GetValue(dgSach.SelectedValue).ToString();
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Có lỗi khi chọn hàng" + ex.Message, "Thông báo", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }

        }

        private bool CheckDL()
        {
            string mess = "";
            if (txtMa.Text == "" || txtName.Text == "" || txtNamXB.Text == "" || txtTrang.Text == "")
            {
                mess += "\nNhap thieu du lieu";
            }
            if (!Regex.IsMatch(txtTrang.Text, @"\d+"))
            {
                mess += "\nSo trang phai la so nguyen";
            }
            else
            {
                int sl = int.Parse(txtTrang.Text);
                if (sl < 0)
                {
                    mess += "\nSo trang phai la so duong";
                }
            }
            if (!Regex.IsMatch(txtNamXB.Text, @"\d+"))
            {
                mess += "\nNam xuat ban phai la so nguyen";
            }
            else
            {
                int sl = int.Parse(txtNamXB.Text);
                if (sl < 0)
                {
                    mess += "\nNam xuat ban phai la so duong";
                }
            }
            if (mess != "")
            {
                MessageBox.Show(mess, "Thong bao", MessageBoxButton.OK, MessageBoxImage.Error);
                return false;
            }
            return true;

        }

        private void btnThem_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (CheckDL())
                {
                    var query = db.Saches.SingleOrDefault(t => t.MaSach.Equals(txtMa.Text));
                    if (query != null)
                    {
                        MessageBox.Show("Da ton tai", "Thong bao", MessageBoxButton.OK);
                        HienThiDL();
                    }
                    else
                    {
                        Sach a = new Sach();
                        a.MaSach = txtMa.Text;
                        a.TenSach = txtName.Text;
                        a.SoTrang = int.Parse(txtTrang.Text);
                        a.NamXuatBan = int.Parse(txtNamXB.Text);
                        TacGium dm = (TacGium)cbTG.SelectedItem;
                        a.MaTg = dm.MaTg;
                        db.Saches.Add(a);
                        db.SaveChanges();
                        MessageBox.Show("Them thanh cong", "Thong bao", MessageBoxButton.OK);
                        HienThiDL();
                    }
                }
            }
            catch (Exception e1)
            {
                MessageBox.Show("Co loi khi them " +  e1.Message, "Thong bao", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void btnSua_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var spSua = db.Saches.SingleOrDefault(sp => sp.MaSach == txtMa.Text);
                if (spSua != null)
                {
                    spSua.TenSach = txtName.Text;
                    spSua.SoTrang = int.Parse(txtTrang.Text);
                    spSua.NamXuatBan = int.Parse(txtNamXB.Text);
                    spSua.MaTg = ((TacGium)cbTG.SelectedItem).MaTg;
                    db.SaveChanges();
                    HienThiDL();
                }
                else
                {
                    MessageBox.Show("Khong thay san pham can sua");
                }
            }
            catch (Exception e1)
            {
                MessageBox.Show("Co loi khi sua: " + e1.Message);
            }
        }

        private void btnXoa_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var query = db.Saches.SingleOrDefault(t => t.MaSach.Equals(txtMa.Text));
                if (query != null)
                {
                    MessageBoxResult rs = MessageBox.Show("Ban co chac chan xoa?", "Thong bao", MessageBoxButton.YesNoCancel);
                    if (rs == MessageBoxResult.Yes)
                    {
                        db.Saches.Remove(query);
                        db.SaveChanges();
                        HienThiDL();
                    }
                }
                else
                {
                    MessageBox.Show("Chua ton tai sach can xoa", "Thong bao");
                    HienThiDL();
                }
            }
            catch (Exception e1)
            {
                MessageBox.Show("Co loi khi xoa: " + e1, "Thong bao");
            }
        }

        private void btnTK_Click(object sender, RoutedEventArgs e)
        {
            Application.Current.Shutdown();
        }

        
    }
}


using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Bai2
{
    class TT
    {
        public string MaSach { get; set; }
        public string TenSach { get; set; }
        public string MaTG { get; set; }
        public int? NamXB { get; set;}
        public int? SoTrang { get; set; }
        public int? TongTien { get; set; }
    }
}



